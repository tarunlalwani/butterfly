/*! butterfly 2022-03-13 */

(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};n=function(){var a;return a=document.body.getAttribute("data-root-path"),a=a.replace(/^\/+|\/+$/g,""),a.length&&(a="/"+a),a},m=function(){return document.body.getAttribute("data-default-theme")},l=function(){return"undefined"!=typeof localStorage&&null!==localStorage?localStorage.getItem("theme"):void 0},x=function(){var a,b,c;if(a=l(),b=m(),c=n()+"/theme/"+b+"/style.css",b&&!a)return y(c)},h=function(a){var b,c,d,e;if(a.indexOf("")<0)return a;for(c=-1,d="",e="normal";c<a.length-1;)switch(b=a.charAt(++c),e){case"normal":if(""===b){e="escaped";break}d+=b;break;case"escaped":if("["===b){e="csi";break}if("]"===b){e="osc";break}"#()%*+-./".indexOf(b)>=0&&c++,e="normal";break;case"csi":if("?>!$\" '".indexOf(b)>=0)break;if("0"<=b&&b<="9")break;if(";"===b)break;e="normal";break;case"osc":""!==b&&""!==b||(""===b&&c++,e="normal")}return d},w=function(a,b){var c;return c=function(d){var e,f,g;if(e=h(d.data.slice(1)),null===b||b.test(e))return butterfly.body.classList.remove("alarm"),f="Butterfly ["+butterfly.title+"]",a?(g=new Notification(f,{body:e,icon:"/static/images/favicon.png"}),g.onclick=function(){return window.focus(),g.close()}):alert(f+"\n"+e),butterfly.ws.shell.removeEventListener("message",c)},butterfly.ws.shell.addEventListener("message",c),butterfly.body.classList.add("alarm")},g=function(a){return a.preventDefault&&a.preventDefault(),a.stopPropagation&&a.stopPropagation(),a.cancelBubble=!0,!1},document.addEventListener("keydown",function(a){var b;if(!a.altKey||65!==a.keyCode)return!0;if(b=null,a.shiftKey){if(b=prompt("Ring alarm when encountering the following text: (can be a regexp)"),!b)return;b=new RegExp(b)}return Notification&&"default"===Notification.permission?Notification.requestPermission(function(){return w("granted"===Notification.permission,b)}):w("granted"===Notification.permission,b),g(a)}),addEventListener("copy",i=function(a){var b,c,d,e,f,g,h;for(document.getElementsByTagName("body")[0].contentEditable=!1,butterfly.bell("copied"),a.clipboardData.clearData(),h=getSelection().toString().replace(/\u00A0/g," ").replace(/\u2007/g," "),b="",g=h.split("\n"),d=0,e=g.length;d<e;d++)f=g[d],"⏎"===f.slice(-1)?(c="",f=f.slice(0,-1)):c="\n",b+=f.replace(/\s*$/,"")+c;return a.clipboardData.setData("text/plain",b.slice(0,-1)),a.preventDefault()}),addEventListener("paste",function(a){var b,c,d;return document.getElementsByTagName("body")[0].contentEditable=!1,butterfly.bell("pasted"),b=a.clipboardData.getData("text/plain"),b=b.replace(/\r\n/g,"\n").replace(/\n/g,"\r"),d=1024,c=function(){if(butterfly.send(b.substring(0,d)),b=b.substring(d),b.length)return setTimeout(c,25)},c(),a.preventDefault()}),addEventListener("beforeunload",function(a){if(!(butterfly.body.classList.contains("dead")||location.href.indexOf("session")>-1))return a.returnValue="This terminal is active and not in session. Are you sure you want to kill it?"}),Terminal.on("change",function(a){if(C.call(a.classList,"extended")>=0)return a.addEventListener("click",function(a){return function(){var b,c;return C.call(a.classList,"expanded")>=0?a.classList.remove("expanded"):(c=a.getBoundingClientRect().height,a.classList.add("expanded"),b=a.getBoundingClientRect().height,document.body.scrollTop+=b-c)}}(a))}),B=function(a,b){var c,d,e,f,g;for(f=a.childNodes,g=[],d=0,e=f.length;d<e;d++)c=f[d],b.call(c),g.push(B(c,b));return g},p=function(a){var b,c,d;return d=/\b(?:https?|ftp):\/\/[a-z0-9-+&@#\/%?=~_|!:,.;]*[a-z0-9-+&@#\/%=~_|]/gim,c=/(^|[^\/])(www\.[\S]+(\b|$))/gim,b=/[\w.]+@[a-zA-Z_-]+?(?:\.[a-zA-Z]{2,6})+/gim,a.replace(d,'<a href="$&">$&</a>').replace(c,'$1<a href="http://$2">$2</a>').replace(b,'<a href="mailto:$&">$&</a>')},z={"&":"&amp;","<":"&lt;",">":"&gt;"},k=function(a){return a.replace(/[&<>]/g,function(a){return z[a]||a})},Terminal.on("change",function(a){return B(a,function(){var a,b,c;if(3===this.nodeType&&(c=this.nodeValue,a=p(k(c)),a!==c))return b=document.createElement("span"),b.innerHTML=a,this.parentElement.replaceChild(b,this),!0})}),j=!1,f=!1,addEventListener("touchstart",function(a){return 2===a.touches.length?j=!0:3===a.touches.length?(j=!1,f=!0):4===a.touches.length?(j=!0,f=!0):void 0}),window.mobileKeydown=function(a){var b,c,d;return!(!j&&!f)&&(c=j,b=f,d=a.keyCode,a.keyCode>=97&&a.keyCode<=122&&(d-=32),a=new KeyboardEvent("keydown",{ctrlKey:c,altKey:b,keyCode:d}),j=f=!1,setTimeout(function(){return window.dispatchEvent(a)},0),!0)},document.addEventListener("keydown",function(a){return!a.altKey||79!==a.keyCode||(open(location.origin+n()+"/"),g(a))}),A=null,s=1e3,o=100,q=function(){var a,b,c,d,e,f;if(butterfly.term.childElementCount>s+butterfly.rows){for(a=document.getElementById("packed"),e=document.createDocumentFragment("fragment"),b=c=0,f=s;0<=f?c<=f:c>=f;b=0<=f?++c:--c)e.appendChild(butterfly.term.firstChild);return d=document.createElement("div"),d.classList.add("pack"),d.appendChild(e),a.appendChild(d),a.childElementCount>o&&a.firstChild.remove(),A=setTimeout(q)}},Terminal.on("refresh",function(){return A&&clearTimeout(A),q()}),Terminal.on("clear",function(){var a,b;return b=document.createElement("div"),b.id="packed",a=document.getElementById("packed"),butterfly.body.replaceChild(b,a)}),a=function(){function a(){this.el=document.getElementById("popup"),this.bound_click_maybe_close=this.click_maybe_close.bind(this),this.bound_key_maybe_close=this.key_maybe_close.bind(this)}return a.prototype.open=function(a){return this.el.innerHTML=a,this.el.classList.remove("hidden"),addEventListener("click",this.bound_click_maybe_close),addEventListener("keydown",this.bound_key_maybe_close)},a.prototype.close=function(){return removeEventListener("click",this.bound_click_maybe_close),removeEventListener("keydown",this.bound_key_maybe_close),this.el.classList.add("hidden"),this.el.innerHTML=""},a.prototype.click_maybe_close=function(a){var b;for(b=a.target;b.parentElement;){if(Array.prototype.slice.call(this.el.children).indexOf(b)>-1)return!0;b=b.parentElement}return this.close(),g(a)},a.prototype.key_maybe_close=function(a){return 27!==a.keyCode||(this.close(),g(a))},a}(),t=new a,v=null,g=function(a){return a.preventDefault&&a.preventDefault(),a.stopPropagation&&a.stopPropagation(),a.cancelBubble=!0,!1},u=function(a){var b;for(b=a.previousSibling,b||(b=a.parentNode.previousSibling),b||(b=a.parentNode.parentNode.previousSibling);b.lastChild;)b=b.lastChild;return b},r=function(a){var b;for(b=a.nextSibling,b||(b=a.parentNode.nextSibling),b||(b=a.parentNode.parentNode.nextSibling);null!=b?b.firstChild:void 0;)b=b.firstChild;return b},b=function(){function a(){butterfly.body.classList.add("selection"),this.selection=getSelection()}return a.prototype.reset=function(){var a,b,c;for(this.selection=getSelection(),a=document.createRange(),a.setStart(this.selection.anchorNode,this.selection.anchorOffset),a.setEnd(this.selection.focusNode,this.selection.focusOffset),this.start={node:this.selection.anchorNode,offset:this.selection.anchorOffset},this.end={node:this.selection.focusNode,offset:this.selection.focusOffset},a.collapsed&&(b=[this.end,this.start],this.start=b[0],this.end=b[1]),this.startLine=this.start.node;!this.startLine.classList||C.call(this.startLine.classList,"line")<0;)this.startLine=this.startLine.parentNode;for(this.endLine=this.end.node,c=[];!this.endLine.classList||C.call(this.endLine.classList,"line")<0;)c.push(this.endLine=this.endLine.parentNode);return c},a.prototype.clear=function(){return this.selection.removeAllRanges()},a.prototype.destroy=function(){return butterfly.body.classList.remove("selection"),this.clear()},a.prototype.text=function(){return this.selection.toString().replace(/\u00A0/g," ").replace(/\u2007/g," ")},a.prototype.up=function(){return this.go(-1)},a.prototype.down=function(){return this.go(1)},a.prototype.go=function(a){var b;if(b=Array.prototype.indexOf.call(butterfly.term.childNodes,this.startLine)+a,0<=b&&b<butterfly.term.childElementCount){for(;!butterfly.term.childNodes[b].textContent.match(/\S/);)if(b+=a,!(0<=b&&b<butterfly.term.childElementCount))return;return this.selectLine(b)}},a.prototype.apply=function(){var a;return this.clear(),a=document.createRange(),a.setStart(this.start.node,this.start.offset),a.setEnd(this.end.node,this.end.offset),this.selection.addRange(a)},a.prototype.selectLine=function(a){var b,c,d;return b=butterfly.term.childNodes[a],d={node:b.firstChild,offset:0},c={node:b.lastChild,offset:b.lastChild.textContent.length},this.start=this.walk(d,/\S/),this.end=this.walk(c,/\S/,!0)},a.prototype.collapsed=function(a,b){var c;return c=document.createRange(),c.setStart(a.node,a.offset),c.setEnd(b.node,b.offset),c.collapsed},a.prototype.shrinkRight=function(){var a,b;if(b=this.walk(this.end,/\s/,!0),a=this.walk(b,/\S/,!0),!this.collapsed(this.start,a))return this.end=a},a.prototype.shrinkLeft=function(){var a,b;if(a=this.walk(this.start,/\s/),b=this.walk(a,/\S/),!this.collapsed(b,this.end))return this.start=b},a.prototype.expandRight=function(){var a;return a=this.walk(this.end,/\S/),this.end=this.walk(a,/\s/)},a.prototype.expandLeft=function(){var a;return a=this.walk(this.start,/\S/,!0),this.start=this.walk(a,/\s/,!0)},a.prototype.walk=function(a,b,c){var d,e,f;if(null==c&&(c=!1),e=a.node.firstChild?a.node.firstChild:a.node,f=null!=e?e.textContent:void 0,d=a.offset,c)for(;e;){for(;d>0;)if(f[--d].match(b))return{node:e,offset:d+1};e=u(e),f=null!=e?e.textContent:void 0,d=f.length}else for(;e;){for(;d<f.length;)if(f[d++].match(b))return{node:e,offset:d-1};e=r(e),f=null!=e?e.textContent:void 0,d=0}return a},a}(),document.addEventListener("keydown",function(a){var c,d,e;if(d=a.keyCode,C.call([16,17,18,19],d)>=0)return!0;if(a.shiftKey&&13===a.keyCode&&!v&&!getSelection().isCollapsed)return butterfly.send(getSelection().toString()),getSelection().removeAllRanges(),g(a);if(v){if(v.reset(),!a.ctrlKey&&a.shiftKey&&37<=(e=a.keyCode)&&e<=40)return!0;if(a.shiftKey&&a.ctrlKey)38===a.keyCode?v.up():40===a.keyCode&&v.down();else if(39===a.keyCode)v.shrinkLeft();else if(38===a.keyCode)v.expandLeft();else if(37===a.keyCode)v.shrinkRight();else{if(40!==a.keyCode)return g(a);v.expandRight()}return null!=v&&v.apply(),g(a)}return!(!v&&a.ctrlKey&&a.shiftKey&&38===a.keyCode)||(c=Math.max(butterfly.term.childElementCount-butterfly.rows,0),v=new b,v.selectLine(c+butterfly.y-1),v.apply(),g(a))}),document.addEventListener("keyup",function(a){var b,c;if(b=a.keyCode,C.call([16,17,18,19],b)>=0)return!0;if(v){if(13===a.keyCode)return butterfly.send(v.text()),v.destroy(),v=null,g(a);if(c=a.keyCode,C.call([37,38,39,40],c)<0)return v.destroy(),v=null,!0}return!0}),document.addEventListener("dblclick",function(a){var b,c,d,e,f;if(!(a.ctrlKey||a.altkey||(f=getSelection(),f.isCollapsed||f.toString().match(/\s/)))){for(e=document.createRange(),e.setStart(f.anchorNode,f.anchorOffset),e.setEnd(f.focusNode,f.focusOffset),e.collapsed&&(f.removeAllRanges(),d=document.createRange(),d.setStart(f.focusNode,f.focusOffset),d.setEnd(f.anchorNode,f.anchorOffset),f.addRange(d));!f.toString().match(/\s/)&&f.toString();)f.modify("extend","forward","character");for(f.modify("extend","backward","character"),b=f.anchorNode,c=f.anchorOffset,f.collapseToEnd(),f.extend(b,c);!f.toString().match(/\s/)&&f.toString();)f.modify("extend","backward","character");return f.modify("extend","forward","character")}}),c=document.body.getAttribute("data-root-path"),document.addEventListener("keydown",function(a){var b;return!a.altKey||69!==a.keyCode||(b=new XMLHttpRequest,b.addEventListener("load",function(){var a,b,c,d,e,f,g,h;if(h=200===this.status,c="<div>",c+="<h2>Session list</h2>",h)if(f=JSON.parse(this.responseText),0===f.sessions.length)c+="No current session for user "+f.user;else{for(c+="<ul>",e=f.sessions,a=0,b=e.length;a<b;a++)g=e[a],d="{_root_path}/session/"+g,c+='<li><a href="{path}">'+g+"</a></li>";c+="</ul>"}return{"else":c+="Failed to fetch list of sessions"},c+="</div>",t.open(c)}),b.open("GET",c+"/sessions/list.json"),b.send(),g(a))}),c=n(),d=function(a){var b;return document.getElementById("style").setAttribute("href",a),b=document.createElement("img"),b.onerror=function(){return setTimeout(function(){return"undefined"!=typeof butterfly&&null!==butterfly?butterfly.resize():void 0},250)},b.src=a},e="undefined"!=typeof localStorage&&null!==localStorage?localStorage.getItem("theme"):void 0,e&&d(e),y=this.set_theme=function(a){if(e=a,"undefined"!=typeof localStorage&&null!==localStorage&&localStorage.setItem("theme",a),a)return d(a)},x(),console.log("Theme should be loaded"),document.addEventListener("keydown",function(a){var b,f;return!a.altKey||83!==a.keyCode||(a.shiftKey?(f=document.getElementById("style").getAttribute("href"),f=f.split("?")[0],d(f+"?"+(new Date).getTime()),g(a)):(b=new XMLHttpRequest,b.addEventListener("load",function(){var a,b,d,f,g,h,i,j,k,l,m,n;if(j=JSON.parse(this.responseText),a=j.builtin_themes,m=j.themes,b='<form>\n  <h2>Pick a theme:</h2>\n  <select id="theme_list">',i=function(a,c){return b+="<option ",e===a&&(b+="selected "),b+='value="'+a+'">',b+=c,b+="</option>"},i(c+"/static/main.css","default"),m.length){for(b+='<optgroup label="Local themes">',d=0,g=m.length;d<g;d++)k=m[d],n=c+("/theme/"+k+"/style.css"),i(n,k);b+="</optgroup>"}for(b+='<optgroup label="Built-in themes">',f=0,h=a.length;f<h;f++)k=a[f],n=c+("/theme/"+k+"/style.css"),i(n,k.slice("built-in-".length));return b+="</optgroup>",b+="  </select>\n  <label>You can create yours in "+j.dir+".</label>\n</form>",t.open(b),l=document.getElementById("theme_list"),l.addEventListener("change",function(){return y(l.value)})}),b.open("GET",c+"/themes/list.json"),b.send(),g(a)))})}).call(this);
//# sourceMappingURL=ext.min.js.map